<!-- <div class="goldgradient beigeborder subnav">
  <button class="btn btn-warning" (click)="goBack()"><i class="fa fa-chevron-left"></i><a> Retour</a></button>
  <h3 style="text-align: center;">Quote</h3>
</div> -->
<div class="container-fluid">

  <div class="hdform">
    <h3><i class="fa fa-university" aria-hidden="true"></i>{{'Quote' | translate}}</h3>
  </div>

  <form [formGroup]="myForm" novalidate (ngSubmit)="save()">
     <div class="row">
      <div class="col-2">
      </div>
      <div class="col-2">
         <button type="button" class="btn btn-primary" (click)="downloadPDF()">
          download PDF
        </button>
      <!--   <h4 class="dspl-nn">id: {{fetchedQuote._id}}</h4> -->
      </div>
      <div class="col-8">
      </div>

    </div>  

    <div class="row">
      <div class="col-2">
      </div>
      <div class="col-3">

        <div class="row">
         
          <!-- <button class="btn btn-outline-primary" [routerLink]="['/quote/public/' + fetchedQuote._id]">
          Devis acces public
        </button> -->
        </div>
        <div class="form-group">
          {{'Type' | translate}}
          <select class="form-control" data-val="true" data-val-number="The field Estimate Template must be a number." id="InvoiceTemplateIDFK" name="InvoiceTemplateIDFK"><option value="30390">Mod&#232;le Facture</option>
                <option selected="selected" value="30391">Mod&#232;le Devis</option>
              </select>
        </div>
        
        
        <div class="form-group">
          <app-autocomplete [search]="search" [enableLink]=true [typeAutocomplete]="'user'" [title]="'Customer'" [search]="{isExternalUser:true}" [title]="" [singleChoice]="'true'" [arrayContent]="fetchedQuote.clients" (getResultAutocomplete)="selectUser($event[0])">
          </app-autocomplete>
        </div>
        <div class="form-group">
          <app-autocomplete [search]="search" [enableLink]=true [typeAutocomplete]="'companie'" [title]="'Companie'" [title]="" [singleChoice]="'true'" [arrayContent]="fetchedQuote.companieClients">
          </app-autocomplete>
        </div>
        <div class="form-group">
          <app-autocomplete [search]="search" [enableLink]=true [typeAutocomplete]="'project'" [title]="'Project'" [singleChoice]="true" [arrayContent]="fetchedQuote.projects">
          </app-autocomplete>
        </div>
        


      </div>


      <div class="col-2">

        <div class="form-group">
          {{'Quote number' | translate}}
          <input class="form-control" id="EstimateCode" name="EstimateCode" type="text" value="28" />
        </div>
   
        <div class="form-group">
          {{'Quote edit date' | translate}}
          <input type="date" class="form-control" [ngModelOptions]="{standalone: true}" class="form-control" [(ngModel)]="fetchedQuote.detail.dateQuote.issueDateString">
        </div>

        <div class="form-group">
          {{'Quote validity date' | translate}}

          <input type="date" class="form-control" [ngModelOptions]="{standalone: true}" class="form-control" [(ngModel)]="fetchedQuote.detail.dateQuote.expiryDateString">

        </div>

        



      </div>

      <div class="col-3">

        <div class="form-group">
          {{'Currency' | translate}}
          <select class="form-control" name="currency" formControlName="currency" [(ngModel)]="fetchedQuote.detail.currency">
                <option value="">Select..</option>
                <option selected="selected" value="EUR">EUR - Euro</option>
                <option value="USD">USD - United States Dollar</option>
              </select>
        </div>

        <div class="form-group">
          {{'Tax Type' | translate}}
          <select name="EstimateTaxConfigCode" class="form-control" id="EstimateTaxConfigCode" data-bind='options: EstimateTaxConfigCodes, optionsText: "Text", optionsValue:"Value", value: EstimateTaxConfigCode'></select>
        </div>

        <div class="form-group">
          {{'Discount in %' | translate}}
          <input id="DiscountPercent" name="DiscountPercent" class="form-control" data-bind='value: formattedDefaultDiscount' />
         </div>
     
        <div class="form-group">
          {{'Status' | translate}}

          <select class="form-control" formControlName="statusQuote" placeholder="" [(ngModel)]="fetchedQuote.statusQuote" name="statusQuote">
                <option *ngFor="let n of statusQuotes" [value]="n.indexStatus">{{n.label}}</option>

              </select>


          <!-- <md-select formControlName="statusQuote" placeholder="" [(ngModel)]="fetchedQuote.statusQuote" name="statusQuote">
            <md-option *ngFor="let n of statusQuotes" [value]="n.indexStatus">
              {{n.label}}
            </md-option>
          </md-select> -->

        </div>



      </div>

      <div class="col-2">
      </div>
      
      <div class="col-2">
      </div>
      <div class="col-8">
        <div class="form-group">
          {{'Quote title' | translate}}
          <input type="text" class="form-control" formControlName="name" [(ngModel)]="fetchedQuote.name" required minlength="5" placeholder="{{'Quote title' | translate}}">
        </div>
            <div class="form-control" *ngFor="let client of fetchedQuote.clients">
              <h4>Client</h4>
              <div>{{client.profile.name}}</div>
              <div>{{client.profile.lastName}}</div>
              <div>{{client.profile.phoneNumber}}</div>

              <div *ngFor="let singleAddress of client.profile.address">
                <h5>Addresse {{singleAddress.nameAddress}}</h5>
                <div>address:{{singleAddress.address}}</div>
                <div>city:{{singleAddress.city}}</div>
                <div>state:{{singleAddress.state}}</div>
                <div>zip:{{singleAddress.zip}}</div>
              </div>
            </div>
        
              <div *ngFor="let companie of fetchedQuote.companieClients">
              <h4>Entreprise</h4>
              <div>{{companie.nameCompanie}}</div>
              <div>{{companie.phoneNumber}}</div>
              <div>{{companie.email}}</div>

              <div *ngFor="let singleAddress of companie.address">
                <h5>Addresse {{singleAddress.nameAddress}}</h5>
                <div>address:{{singleAddress.address}}</div>
                <div>city:{{singleAddress.city}}</div>
                <div>state:{{singleAddress.state}}</div>
                <div>zip:{{singleAddress.zip}}</div>
              </div>
            </div>      
      </div> 
      <div class="col-2">
      </div>



    
      <div class="col-12">
        <div class="row">
          <div>




            <!-- <div *ngFor="let project of fetchedQuote.projects">
              <div *ngFor="let user of project.assignedTos">
                Owner Project: {{user.profile.name}}
              </div>
            </div> -->


            <div class="form-control" *ngFor="let client of fetchedQuote.clients">
              <h4>Client</h4>
              <div>{{client.profile.name}}</div>
              <div>{{client.profile.lastName}}</div>
              <div>{{client.profile.phoneNumber}}</div>

              <div *ngFor="let singleAddress of client.profile.address">
                <h5>Addresse {{singleAddress.nameAddress}}</h5>
                <div>address:{{singleAddress.address}}</div>
                <div>city:{{singleAddress.city}}</div>
                <div>state:{{singleAddress.state}}</div>
                <div>zip:{{singleAddress.zip}}</div>
              </div>
            </div>

            <div *ngFor="let companie of fetchedQuote.companieClients">
              <h4>Entreprise</h4>
              <div>{{companie.nameCompanie}}</div>
              <div>{{companie.phoneNumber}}</div>
              <div>{{companie.email}}</div>

              <div *ngFor="let singleAddress of companie.address">
                <h5>Addresse {{singleAddress.nameAddress}}</h5>
                <div>address:{{singleAddress.address}}</div>
                <div>city:{{singleAddress.city}}</div>
                <div>state:{{singleAddress.state}}</div>
                <div>zip:{{singleAddress.zip}}</div>
              </div>
            </div>

          </div>
        </div>





        <div class="form-control">
          <div class="row ac">
            <div class="h6 col-1"></div>
            <div class="h6 col-md-1">{{'Image' | translate}}</div>
            <div class="h6 col-6">{{'Item' | translate}}</div>
            <!-- <div class="h6 col-md-2">{{'Ref' | translate}}</div> -->
            <div class="h6 col-1">{{'Quantity' | translate}}</div>
            <div class="h6 col-1">{{'Price excl tax' | translate}}</div>
            <div class="h6 col-1">{{'VAT(%)' | translate}}</div>
            <div class="h6 col-1">{{'Total excl tax' | translate}}</div>
            <!-- <div class="h6 col-2">{{'Total with taxes' | translate}}</div> -->
          </div>

          <!-- <button type="button" class="btn btn-success" (click)="addBucketProducts()">AddBucketProducts</button> -->
          <div *ngFor="let devisDetail of fetchedQuote.devisDetails; let i=index">
            <div class="row">
              <input class="form-control col-2" type="text" [ngModelOptions]="{standalone: true}" [(ngModel)]="fetchedQuote.devisDetails[i].nameBucketProducts" placeholder="Category">
              <button type="button" class="btn btn-danger btn-sm" (click)="removeBucketProducts(i)"><i class="fa fa-times"></i></button>
            </div>
            <div [dragulaModel]='fetchedQuote.devisDetails[i].bucketProducts' [dragula]='"third-bag"'>
              <div *ngFor="let bucketProduct of devisDetail.bucketProducts; let j=index">

                <div class="row ac">

                  <div class="col-1">
                    <div class="row">
                      <button type="button" class="btn btn-danger btn-sm" (click)="removeRow(i, j)"><i class="fa fa-times"></i></button>

                      <button type="button" class="btn btn-sm handle"><i class="fa fa-arrows handle"></i></button>
                      <!-- <button type="button" class="btn btn-sm" (click)="editRaw(i, j)"><i class="fa fa-times"></i></button> -->
                    </div>
                  </div>

                  <div class="col-1">
                    <div *ngIf="bucketProduct.typeRow=='product'">
                      <div *ngFor="let product of fetchedQuote.devisDetails[i].bucketProducts[j].productInit">
                        <app-picture [addPicture]=false [deletePicture]=false [forms]="product.forms"></app-picture>
                      </div>
                    </div>

                  </div>

                  <div class="col-6">
                    <div *ngIf="bucketProduct.typeRow=='product'">
                      <app-autocomplete [typeAutocomplete]="'product'" [title]="" [singleChoice]=true [arrayContent]="fetchedQuote.devisDetails[i].bucketProducts[j].productInit" (getResultAutocomplete)="selectProduct($event[0], i, j)">
                      </app-autocomplete>
                    </div>
                    <!-- <a [routerLink]="['/product/' + bucketProduct.productInit._id]" class="admn-btn">
                    {{bucketProduct.productInit.details.reference}}
                  </a> -->
                    <div *ngIf="bucketProduct.typeRow=='text'">
                      <quill-editor [ngModelOptions]="{standalone: true}" [(ngModel)]="fetchedQuote.devisDetails[i].bucketProducts[j].title">
                        <div quill-editor-toolbar>
                          <span class="ql-formats">
                        <button class="ql-bold" [title]="'Bold'"></button>
                        <button class="ql-italic" [title]="'Italic'"></button>
                        <button class="ql-underline" [title]="'Underline'"></button>

                      </span>
                          <span class="ql-formats">
                        <button class="ql-list" [title]="'list'" value='ordered'></button>
                        <button class="ql-list" [title]="'list'" value='bullet'></button>
                        <!-- <button class="ql-italic" [title]="'Italic'"></button> -->

                      </span>

                          <span class="ql-formats">
                        <select class="ql-align" [title]="'Aligment'">
                          <option selected></option>
                          <option value="center"></option>
                          <option value="right"></option>
                          <option value="justify"></option>
                        </select>
                      </span>
                        </div>
                      </quill-editor>

                      <!-- <ckeditor
                    [ngModelOptions]="{standalone: true}"
                    [(ngModel)]="fetchedQuote.devisDetails[i].bucketProducts[j].title"
                    [config]="ckeConfig"
                    [readonly]="false"
                    (change)="onChange($event)"
                    (ready)="onReady($event)"
                    (focus)="onFocus($event)"
                    (blur)="onBlur($event)"
                    debounce="500">
                  </ckeditor> -->
                    </div>
                  </div>
                  <!-- <div class="col-md-2">
                <a [routerLink]="['/product/' + bucketProduct.productInit._id]" class="admn-btn">
                          {{bucketProduct.productInit.details.reference}}
                        </a>
              </div> -->
                  <div class="col-1">
                    <input class="gooplusInput ac" type="number" (ngModelChange)="calculateQuote()" [ngModelOptions]="{standalone: true}" [(ngModel)]="fetchedQuote.devisDetails[i].bucketProducts[j].quantity" placeholder="quantity">
                    <div *ngIf="bucketProduct.typeRow=='product'">

                      <div *ngFor="let product of fetchedQuote.devisDetails[i].bucketProducts[j].productInit">
                        {{product.details.unit}}
                      </div>

                    </div>
                  </div>
                  <div class="col-1 ac">
                    <input class="gooplusInput ac" type="number" (ngModelChange)="calculateQuote()" [ngModelOptions]="{standalone: true}" [(ngModel)]="fetchedQuote.devisDetails[i].bucketProducts[j].priceWithoutTaxes" placeholder="priceWithoutTaxes">
                  </div>

                  <div class="col-md-1 ac">
                    <input class="gooplusInput ac" type="text" (ngModelChange)="calculateQuote()" [ngModelOptions]="{standalone: true}" [(ngModel)]="fetchedQuote.devisDetails[i].bucketProducts[j].vat" placeholder="vat">
                  </div>
                  <div class="col-1">
                    {{fetchedQuote.devisDetails[i].bucketProducts[j].totalPriceWithoutTaxes | round}}
                  </div>
                  <!-- <div class="col-2">
                {{fetchedQuote.devisDetails[i].bucketProducts[j].totalPriceWithTaxes | round}}
              </div>  -->
                </div>
              </div>
            </div>
          </div>


          <div class="row ac font-weight-bold">
            <div class="col-3">
            
              <select class="form-control" #t (change)="addRow(t.value); t.value = ''">
            <option [attr.value]="''">{{'Add row' | translate}}</option>
            <option *ngFor="let n of rowTypes" [attr.value]="n.value">{{n.label}}</option>
          </select>
                         
              
            </div>
            <div class="col-3">
            </div>
            <div class="col-2 form-control fcp">
              {{'Total' | translate}}
            </div>
            <div class="col-2 form-control">
              {{fetchedQuote.priceQuote.priceQuoteWithoutTaxes | round}} € HT
            </div>
            <div class="col-2 form-control">
              {{fetchedQuote.priceQuote.priceQuoteWithTaxes | round}} € TTC
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-3">
            <div class="row">
              <select class="form-control" #t (change)="addRow(t.value); t.value = ''">
            <option [attr.value]="''">{{'Add row' | translate}}</option>
            <option *ngFor="let n of rowTypes" [attr.value]="n.value">{{n.label}}</option>
          </select>
            </div>
            <div class="row">
              <input type="text" class="form-control" placeholder="nameTemplate" #nameTemplate>
              <button type="button" class="btn btn-success" (click)="saveTemplateQuote(nameTemplate.value)">saveTemplateQuote</button>
            </div>
            <div class="row">
              <app-autocomplete [typeAutocomplete]="'templateQuote'" [title]="" [singleChoice]=true [arrayContent]="arrayContentToSearch" (getResultAutocomplete)="selectTemplateQuote($event[0])">
              </app-autocomplete>
            </div>
          </div>

          <div class="col-5">
            <div *ngIf="fetchedQuote._id">
              <div class="FormGroup">
                <button type="button" class="btn btn-warning" (click)="showLogs = !showLogs">
                 <i class="fa fa-calendar" aria-hidden="true"></i>
                 <span>{{'Show Comments' | translate}}</span>
                </button>

                <div *ngIf="showLogs">
                  <app-comments [search]="search"></app-comments>
                </div>
              </div>

            </div>
            <!-- <textarea class="form-control" rows="10" placeholder="Infos" ></textarea> -->
          </div>




          <div class="col-4">

            <div class="">
              <div class="card" style="width:100%;">
                <div *ngIf="!fetchedQuote.signature.base64">
                  <button type="button" class="delete" md-button (click)="resetSignature()">
                  {{'Reset' | translate}}
              </button>
                  <signature-pad [options]="signaturePadOptions" (onBeginEvent)="drawStart()" (onEndEvent)="drawComplete()">
                  </signature-pad>
                  <button type="button" class="delete" md-button (click)="validateSignature()">
                  ok
              </button>
                </div>
                <div *ngIf="fetchedQuote.signature.base64">
                  <img [src]="fetchedQuote.signature.base64" />
                  <div *ngFor="let user of fetchedQuote.signature.users">
                    {{fetchedQuote.signature.dateSignature | date:'yMdjm'}} - {{user.profile.name }}
                  </div>
                  <button type="button" class="delete" md-button (click)="removeSignature()">
                  {{'Unsign' | translate}}
              </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div (click)="togglePaiements()">Paiements</div>
        <div *ngIf="showPaiements">
          <button class="btn btn-success" type="button" md-button (click)="openDialog()">
          <i class="fa fa-plus"></i> Add new one
        </button>
          <br>
          <app-paiementQuotes (getPaiementQuotesCross)="getPaiementQuotes($event)" [showHeader]="false" [showCreate]="false" [idQuote]="fetchedQuote._id">
          </app-paiementQuotes>
          {{'Total Paiement' | translate}} = {{totalPaiementAmount}}
          <br> {{'To be paid' | translate}} = {{fetchedQuote.priceQuote.priceQuoteWithoutTaxes*1 - totalPaiementAmount*1| round}}
          <!-- <app-paiementQuote [showHeader]="false" (newPaiementQuoteSaved)="newPaiementQuoteSaved()">
        </app-paiementQuote> -->
        </div>



      </div>


      <br><br>
      <div class="col-12">
        <div class="valid-edit">
          <button type="submit" class="btn valid">{{'Save' | translate}}</button>
          <button *ngIf="fetchedQuote._id" type="button" class="btn false" (click)="openDialogDelete()">
            {{'Delete' | translate}}
          </button>
        </div>
      </div>
    </div>
  </form>
</div>
<app-loadingInApp *ngIf="loading"></app-loadingInApp>
